### 0. 前言
此文档主要对于机器在安装前进行标准化和相应配置管理，集成主要的运维部署操作，提升部署效率降低错误概率，如果机器已经初始化完成，此文档步骤可省略。

### 1. 参考文档
http://prophet-devops.4pd.io:8086/sre-new-document/02-sys-init.html

### 2. 获取工具包
下载地址：

centos/redhat>=7.5: http://pkg-plus.4paradigm.com/prophet/dev-tools/sys-init.tar.gz

centos/redhat8.2: http://pkg-plus.4paradigm.com/prophet/cess/dev-tools/sys-init-el8.tar.gz

GPU系列：

http://pkg-plus.4paradigm.com/prophet/dev-tools/sys-init-cuda-10.2.tar.gz

http://pkg-plus.4paradigm.com/prophet/dev-tools/sys-init-cuda-11.1.tar.gz

http://pkg-plus.4paradigm.com/prophet/dev-tools/sys-init-cuda-11.2.tar.gz

中关村银行定制版：
http://pkg-plus.4paradigm.com/prophet/cess/dev-tools/system-init-78.tar.gz

```
#上传安装包
#如果控制节点没有wget命令，可以使用如下命令安装。
yum install wget -y
#如果控制节点网络隔离，可以直接在本地scp安装包。
 
#在公司内网部署可以直接通过wget获取
cd /opt/ && wget http://pkg-plus.4paradigm.com/prophet/dev-tools/sys-init.tar.gz  #公司内网可以直接下载
 
#如果是公网环境或者与公司内网隔离，请手动将安装包上传至控制节点,如果没有特别需求，建议上传是/opt/路径下
scp ./sys-init.tar.gz root@{{ 控制节点IP }}:/opt/
 
#解压安装包
cd /opt/ && tar -zxvf sys-init.tar.gz
```

### 3. 配置初始化参数
#### 3.1 简要介绍

```
#配置文件位置
cd sys-init/etc/
- hosts #用于配置hostname，custom.sh会将配置内容与此文件内容比对，同时作为整个集群的hosts配置管理
- custom.sh #服务器分组，应用安装分配，内部yum源配置等
```

#### 3.2 hosts文件配置详解
此文件配置方式与系统hosts文件配置方式一致（IP hostname）

以 完整的k8s + aios + 中间件 + hadoop配置举例：
```
sys-init/etc/hosts
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
#服务器host信息，示例如下：
#172.27.10.2 test-hdp01
172.27.10.2 k8s-master01       #k8s集群管理节点，部署k8s master进程与etcd
172.27.10.3 k8s-master02
172.27.10.4 k8s-master03
172.27.10.5 k8s-node-system01  #k8s集群node节点，部署k8s node进程、docker、AIOS管理部分label、hostpath
172.27.10.6 k8s-node-online01  #k8s集群node节点，部署k8s node进程、docker、AIOS在线应用label
172.27.10.7 k8s-node-offline01 #k8s集群node节点，部署k8s node进程、docker、AIOS离线应用label
172.27.10.8 mw-zk01            #中间件节点，部署zookeeper，也可以是kafka、es、rtidb等中间件应用
172.27.10.9 mw-zk02
172.27.10.10 mw-zk03
172.27.10.11 cdh-scm01         #CDH集群scm节点，CDH用于管理hadoop应用的进程
172.27.10.12 cdh-master01      #CDH集群hadoop应用master节点，例如：namenode等
172.27.10.13 cdh-master02
172.27.10.14 cdh-master03
172.27.10.15 cdh-node01        #CDH集群hadoop应用node（工作）节点，例如：yarn node-manager,hdfs datanode
172.27.10.16 cdh-node02
172.27.10.17 cdh-node03
#注-1：以上配置仅为示例，实际环境请根据实际IP和hostname填写
#注-2：实际使用中，可以仅针对部分实例进行初始化，对初始化范围无硬性要求，同时标准化部署工具与已有的部署逻辑没有耦合关系。
```
#### 3.3 costum.sh配置文件详解
以 完整的k8s + aios + 中间件 + hadoop配置举例：

小技巧：通过hosts文件快速获取hostname列表(例如k8s-node)： cat hosts | grep 'k8s-node' | awk '{print $2}'
```
#固定配置，无需修改
node_type_list='
k8s_master
k8s_node
hadoop_master
hadoop_node
hadoop_cm
nvidia_gpu_node
mysql_master
mw_node
others
'
 
#可选配置：用于在有统一root密码的情况下使用sshpass批量配置控制节点到所有节点的root账户ssh免密
#注：只能填写IP
all_ip_list='
172.27.10.2
'
#可选配置：统一root密码，非统一则不支持
passwd='
123456
'
 
#可选配置：k8s节点群组，填写hostname即可，注：根据实际情况填写，以下为示例
k8s_master='
k8s-master01
k8s-master02
k8s-master03
'
 
#可选配置：k8s工作节点，升级内核功能默认会选择此群组服务器进行操作。
k8s_node='
k8s-node-system01
k8s-node-online01
k8s-node-offline01
'
 
#可选配置：hadoop master群组,CDH自动安装工具会在此节点自动安装scm agent
hadoop_master='
cdh-master01
cdh-master02
cdh-master03
'
 
#可选配置：hadoop node群组,CDH自动安装工具会在此节点自动安装scm agent
hadoop_node='
cdh-node01
cdh-node02
cdh-node03
'
 
#可选配置：cdh scm管理节点,CDH自动安装工具会在此节点自动安装scm server
hadoop_cm='
cdh-scm01
'
 
#可选配置：中间件节点，jdk安装脚本会自动在此群组节点配置jdk环境
mw_node='
mw-zk01
mw-zk02
mw-zk03
'
 
#可选配置：mysql单点安装脚本会自动在此群组节点安装mysql服务
#注：可同时在多个节点安装mysql，但不是集群
mysql_master='
cdh-scm01
'
 
#可选配置：GPU自动安装脚本会在此群组节点安装配置GPU驱动
nvidia_gpu_node='
'
 
#nvidia driver 版本选择（440.33.01，450.51.05, 460.32.03）
nvidia_gpu_version='440.33.01'
 
#是否需要安装cuda driver, 默认为false
cuda_install='false'
 
#可选配置：如果需要统一初始化和批量运维，且无特定群组，可以将节点加入
others='
test01
'
 
#需要安装jdk环境的群组 or 服务器 ,注意：写成一行，不同组用空格分隔，举例："group_a group_b server_a"
jdk_group_list='mw_node hadoop_cm hadoop_node hadoop_master'
 
 
#离线服务配置
#可选配置：自动安装nfs server
nfs_server=''
nfs_data_path=''
 
#可选配置：自动安装ntpd server
ntpd_server=''
 
#必选配置：集群内部离线yum源server，必须配置，并建议配置IP。
repo_hosts='172.27.10.2'
repo_port='20001'   #端口可配，非冲突情况下不建议修改
 
#必选配置：yum源离线存储位置，一般不需要修改，可自定义
repo_yum_dir='/srv/cess_repo'
 
#######mysql相关配置###########
#mysql数据库密码，一般不需要修改
mysql_passwd='Admin@4pd'
#mysql配置文件位置(包括文件夹路径)
mysql_dir='/mnt/disk0/mysql'
 
#可选配置：GPU驱动相关配置，需要是否需要安装kernel headers和devel及需要安装的版本(目前只支持centos 7系列的内核版本，其他特殊内核版本请设置为false，并自行安装headers 和 devel)
package_install_needed='true'
```

### 4. sys-init安装与标准初始化
#### 4.1 控制节点安装与统一初始化
```
#进入cess-system-init目录
cd /opt/sys-init
 
#1、创建离线yum源 - 可重复操作
bash ./bin/create_local_repo.sh
 
#2、安装配置ansible server - 可重复操作
bash ./bin/create_ansible_server.sh
 
#3【按需操作】配置控制节点到所有节点的root ssh免密（根据实际情况--可选）
bash ./bin/p_sshcopy.sh
 
#3.1、如果集群服务没有统一密码，需要手动建立控制节点到所有节点间的ssh免密，步骤如下
#3.1、获取控制节点（运维工具所在节点）公钥，如没有需生成
ssh-keygen  #一直回车，在没有公钥的情况下
#获取控制节点公钥
cat ~/.ssh/id_rsa.pub
 
#在所有节点执行如下命令：
echo '{ 公钥内容 }' >> ~/.ssh/authorized_keys
 
#错误排查：如果无法免密ssh，可以做如下检查：
[.ssh]# ls -la
drwx------  2 root root 4096 4月  26 12:59 .
dr-xr-x---. 4 root root 4096 4月  26 13:57 ..
-rw-------  1 root root 1230 4月  26 12:59 authorized_keys
-rw-------  1 root root 1675 4月  26 12:59 id_rsa
-rw-r--r--  1 root root  410 4月  26 12:59 id_rsa.pub
-rw-r--r--  1 root root  181 4月  26 12:59 known_hosts
 
#确认如下文件权限是否正确：
.ssh 700
authorized_keys 600
id_rsa.pub 644
id_rsa 600
 
#如不正确，修改为正确权限：chmod XXX filename
 
#4、所有节点进行统一标准初始化 - 可重复操作
bash ./bin/ansible_all_init.sh
4.2 自动运维功能和特定节点配置
#【按需操作】可重复操作：批量安装配置jdk （etc/custom.sh中jdk_group_list配置）
bash ./bin/jdk_install.sh
 
#【按需操作】可重复操作：批量升级k8s工作节点kernel(针对etc/custom.sh中k8s_node群组进行升级)
bash ./bin/up_kernel.sh
goan && ansible k8s_node -m shell -a "reboot" #重启服务器使新内核生效
goan && anping  #查看服务器状态是否正常（是否可ping）
 
#【按需操作】不可重复操作：磁盘分区，针对不同群组进行磁盘分区
#命令格式: bash ./bin/disk_init.sh {{ groupname }} {{ disk }} {{ mountpath }} #groupname为前述custom.sh文件中的node_type_list列表成员
goan && ansh "parted -l | grep dev | grep -v da"  #示例: 查看所有节点磁盘情况
bash ./bin/disk_init.sh hadoop_node /dev/vdb /mnt/disk0 #示例: 针对对应群组，对节点进行磁盘分区
 
#如果已有挂载的批量处理方式,例如/dev/vdb已经挂载
ansh "umount /dev/vdb"
ansh "sed -i '/vdb/d' /etc/fstab"
ansh "parted /dev/vdb mklabel gpt -s"
 
#【按需操作】可重复操作: 安装配置nfs server
bash ./bin/nfs_install.sh
 
#【按需操作】不可重复操作：安装mysql
bash ./bin/install_mysql.sh
```

### 5.【按需使用】自定义批量运维操作（批量shell）
```
#批量执行shell
goan  #进入ansible执行目录，批量命令需要在此目录下执行才生效。
ansh "{{ shell }}"  #针对所有服务器批量执行自定义shell
anping  #判断所有服务器连通性
 
#批量运维命令举例：
ansh "ls /opt/"  #执行ls命令
 
#针对单个群组或者服务器执行批量命令的两种方法。
#1、修改ansible/hosts配置文件的[all_node:children]列表，注释或者删除相应群组，以及注释或删除群组内相应节点。
#2、通过如下命令执行群组或者机器执行命令：
goan && ansible {{ group or host }} -m shell -a "{{ shell }}"
 
#示例：查看中间件群组所有节点的磁盘信息
ansible mw_node -m shell -a "df -hT"
```

### 6.【按需使用】添加新节点&配置刷新
```
#前提条件：控制节点与新加入节点为root ssh免密状态。
#1、配置./etc/hosts将新节点信息写入
#2、将新节点hostname写入./etc/hosts相应群组
#3、刷新ansible hosts配置
bash ./bin/create_ansible_server.sh
#4、执行批量初始化
bash ./bin/ansible_all_init.sh
 
#5、自定义后续初始化部分，按需执行，可重复执行
bash ./bin/jdk_install.sh
bash ./bin/up_kernel.sh
```